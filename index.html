<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üè∏ Badminton Score App</title>
  <style>
    body {
      font-family: "Segoe UI", "Noto Sans Thai", sans-serif;
      background: #f5f6fa;
      margin: 20px;
      color: #333;
    }
    h2, h3 {
      margin-bottom: 10px;
      font-weight: 600;
    }
    .container {
      background: #fff;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 220px;
      font-size: 14px;
    }
    button {
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    button:hover { opacity: 0.9; }
    .btn-blue { background: #3498db; color: #fff; }
    .btn-green { background: #2ecc71; color: #fff; }
    .btn-yellow { background: #f1c40f; color: #fff; }
    .btn-red { background: #e74c3c; color: #fff; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #2ecc71;
      color: #fff;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover td { background: #f1f1f1; }

    .score-cell { cursor: pointer; }
    .delete-btn { color: red; margin-left: 6px; cursor: pointer; }

    .history-item {
      background: #fdfdfd;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .undo-btn {
      background: #2ecc71;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .undo-btn:hover { background: #27ae60; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üè∏ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏ö‡∏î</h2>
    <input type="text" id="playerName" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏á - ‡∏û‡∏£‡∏µ‡∏°)">
    <button class="btn-blue" onclick="addPlayer()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
    <button class="btn-red" onclick="resetAll()">‚ôª ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    <button class="btn-yellow" onclick="toggleHistory()">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
  </div>

  <div class="container" id="matchTable"></div>

  <div class="container ranking">
    <h3>üèÜ Ranking</h3>
    <table id="rankingTable">
      <thead>
        <tr>
          <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</th>
          <th>‡∏ä‡∏ô‡∏∞</th>
          <th>‡πÅ‡∏û‡πâ</th>
          <th>‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="container history-page" id="historyPage" style="display:none;">
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
    <div id="historyLog"></div>
  </div>

  <script>
    let players = [];
    let results = {}; 
    let historyLog = []; 

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
    function loadData() {
      if (localStorage.getItem("players")) players = JSON.parse(localStorage.getItem("players"));
      if (localStorage.getItem("results")) results = JSON.parse(localStorage.getItem("results"));
      if (localStorage.getItem("historyLog")) historyLog = JSON.parse(localStorage.getItem("historyLog"));
      renderTable();
      updateRanking();
      renderHistory();
    }

    // ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function saveData() {
      localStorage.setItem("players", JSON.stringify(players));
      localStorage.setItem("results", JSON.stringify(results));
      localStorage.setItem("historyLog", JSON.stringify(historyLog));
    }

    function getKey(p1, p2) {
      return [p1, p2].sort().join("|");
    }

    function addPlayer() {
      let name = document.getElementById("playerName").value.trim();
      if (name && !players.includes(name)) {
        players.push(name);
        document.getElementById("playerName").value = "";
        renderTable();
        updateRanking();
        saveData();
      }
    }

    function resetAll() {
      if (!confirm("‚ö†Ô∏è ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
      players = [];
      results = {};
      historyLog = [];
      renderTable();
      updateRanking();
      renderHistory();
      saveData();
    }

    function renderTable() {
      let html = "<table><tr><th></th>";
      players.forEach(p => html += `<th>${p}</th>`);
      html += "</tr>";

      players.forEach((p1, i) => {
        html += `<tr><th>${p1}</th>`;
        players.forEach((p2, j) => {
          if (i === j) {
            html += `<td style="background:#f8f9fa">-</td>`;
          } else {
            let key = getKey(p1, p2);
            let match = results[key] || {};
            let display = match.score1 !== undefined ? 
              (match.p1 === p1 ? `${match.score1}:${match.score2}` : `${match.score2}:${match.score1}`) 
              + ` <span class='delete-btn' onclick="deleteResult('${key}')">‚úï</span>` : "";
            html += `<td class="score-cell" onclick="enterScore('${p1}','${p2}')">${display}</td>`;
          }
        });
        html += "</tr>";
      });

      html += "</table>";
      document.getElementById("matchTable").innerHTML = html;
    }

    function enterScore(p1, p2) {
      let s1 = prompt("‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á " + p1);
      let s2 = prompt("‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á " + p2);
      if (s1 !== null && s2 !== null && !isNaN(s1) && !isNaN(s2)) {
        let key = getKey(p1, p2);
        let oldResult = results[key] ? {...results[key]} : null;
        results[key] = {p1, p2, score1: parseInt(s1), score2: parseInt(s2)};
        historyLog.push({ 
          action: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•", 
          text: `${p1} ${s1} - ${s2} ${p2}`, 
          key, 
          oldResult 
        });
        updateRanking();
        renderTable();
        renderHistory();
        saveData();
      }
    }

    function deleteResult(key) {
      if (results[key]) {
        let {p1, p2, score1, score2} = results[key];
        let oldResult = {...results[key]};
        historyLog.push({ 
          action: "‡∏•‡∏ö‡∏ú‡∏•", 
          text: `${p1} ${score1} - ${score2} ${p2}`, 
          key, 
          oldResult 
        });
        delete results[key];
        updateRanking();
        renderTable();
        renderHistory();
        saveData();
      }
    }

    function undoAction(index) {
      let log = historyLog[index];
      if (!log) return;

      if (log.action === "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•") {
        if (log.oldResult) {
          results[log.key] = log.oldResult;
        } else {
          delete results[log.key];
        }
      } else if (log.action === "‡∏•‡∏ö‡∏ú‡∏•") {
        results[log.key] = log.oldResult;
      }

      historyLog.push({ action: "Undo", text: `‚Ü© ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô: ${log.text}` });
      updateRanking();
      renderTable();
      renderHistory();
      saveData();
    }

    function updateRanking() {
      let stats = {};
      players.forEach(p => stats[p] = {wins: 0, losses: 0, points: 0});

      for (let key in results) {
        let {p1, p2, score1, score2} = results[key];
        stats[p1].points += score1;
        stats[p2].points += score2;
        if (score1 > score2) { stats[p1].wins++; stats[p2].losses++; }
        else if (score2 > score1) { stats[p2].wins++; stats[p1].losses++; }
      }

      let ranking = Object.entries(stats).map(([name, data]) => ({ name, ...data }));
      ranking.sort((a, b) => b.wins - a.wins || b.points - a.points);

      let tbody = document.querySelector("#rankingTable tbody");
      tbody.innerHTML = "";
      ranking.forEach((p, i) => {
        let row = `<tr>
          <td>${i + 1}</td>
          <td>${p.name}</td>
          <td>${p.wins}</td>
          <td>${p.losses}</td>
          <td>${p.points}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function toggleHistory() {
      let page = document.getElementById("historyPage");
      page.style.display = (page.style.display === "none" || page.style.display === "") ? "block" : "none";
    }

    function renderHistory() {
      let logDiv = document.getElementById("historyLog");
      logDiv.innerHTML = "";
      historyLog.forEach((item, index) => {
        logDiv.innerHTML += `<div class="history-item">${item.action}: ${item.text} 
          <button class="undo-btn" onclick="undoAction(${index})">Undo</button></div>`;
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadData();
  </script>
</body>
</html>
